<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‹¼å›¾Ultimate (Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            color: #000000;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 200px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }/* iOSé£æ ¼å¡ç‰‡å®¹å™¨ */
        .ios-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }
        
        /* åˆ—è¡¨é¡¹åˆ†å‰²çº¿ */
        .ios-divide > div:not(:last-child), 
        .ios-divide > label:not(:last-child) { 
            border-bottom: 0.5px solid #C6C6C8; 
        }
        
        /* è¡¨å•æ§ä»¶æ ·å¼é‡ç½® */
        input[type=number], select, input[type=text] { appearance: none; -webkit-appearance: none; background: transparent; }/* --- iOS é£æ ¼æ»‘åŠ¨æ¡æ ·å¼ --- */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 24px;
            margin: 0;
            padding: 0;
            cursor: pointer;
        }
        /* æ»‘åŠ¨è½¨é“ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #E5E5EA;
            border-radius: 2px;
            border: none;
        }
        /* æ»‘å— */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            border: 0.5px solid rgba(0,0,0,0.04);
            margin-top: -9px;
            transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.1);
        }/* æ¨¡æ€æ¡†èƒŒæ™¯ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(4px); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        /* é€æ˜æ£‹ç›˜æ ¼èƒŒæ™¯ */
        .checkered-bg {
            background-color: #eee;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
                              linear-gradient(-45deg, #ccc 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #ccc 75%),
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .action-sheet {
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #F2F2F7; border-top-left-radius: 16px; border-top-right-radius: 16px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 101; padding: 20px; padding-bottom: 40px;
        }
        .action-sheet.show { transform: translateY(0); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased">
    <header class="sticky top-0 z-50 bg-[#F2F2F7]/90 backdrop-blur-xl border-b border-gray-200/50 supports-[backdrop-filter]:bg-[#F2F2F7]/60">
        <div class="max-w-2xl mx-auto px-5 py-3 flex justify-between items-center h-[52px]">
            <h1 class="text-[22px] font-bold tracking-tight text-black">æ‹¼å›¾æ’åº<span class="text-xs font-normal text-white bg-black px-1.5 py-0.5 rounded">Pro</span></h1>
            <button onclick="document.getElementById('fileInput').click()" class="bg-white text-[#007AFF] text-[15px] font-bold px-4 py-1.5 rounded-full shadow-sm active:bg-gray-100 transition flex items-center gap-1">
                <svg class="w-4 h-4 stroke-[3px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                æ·»åŠ 
            </button>
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFiles(this.files)">
            <input type="file" id="replaceInput" accept="image/*" class="hidden" onchange="handleReplaceAction(this.files)">
            <input type="file" id="stickerInput" accept="image/*" class="hidden" onchange="handleStickerFile(this.files)">
        </div>
    </header><main class="max-w-2xl mx-auto px-4 pt-4">
        <div id="progressModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl w-64 shadow-2xl text-center">
                <div class="mb-3 text-[17px] font-medium text-gray-800" id="progressText">å¤„ç†ä¸­...</div>
                <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div id="progressBar" class="bg-[#007AFF] h-full w-0 transition-all duration-100"></div>
                </div>
                <div class="mt-2 text-xs text-gray-400 mb-4" id="progressDetail">0/0</div>
                
                <button onclick="cancelProcess()" class="bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-600 text-sm font-medium py-1.5 px-6 rounded-full transition-colors">
                    å–æ¶ˆ
                </button>
            </div>
        </div><div class="ios-card p-4">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[13px] text-gray-500 uppercase font-medium pl-1">å·²å¯¼å…¥ <span id="countBadge">0</span> å¼ </span>
                <button onclick="clearAll()" class="text-[#FF3B30] text-[13px] active:opacity-50 transition hidden" id="clearBtn">æ¸…ç©º</button>
            </div>
            <div id="imageGrid" class="grid grid-cols-4 gap-2 overflow-y-auto max-h-[280px] min-h-[100px] no-scrollbar">
                <div id="emptyState" class="col-span-full flex flex-col items-center justify-center py-8 space-y-3">
                    <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <span class="text-gray-400 text-sm">å¯¼å…¥å›¾ç‰‡ (ç‚¹å‡»å›¾ç‰‡å¯æ›¿æ¢/åˆ é™¤)</span>
                </div>
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">å¸ƒå±€è®¾ç½®</div>
        <div class="ios-card ios-divide">
            <div class="p-4 bg-white active:bg-gray-50 transition">
                <div class="flex items-center justify-between">
                    <span class="text-[17px]">åˆ—æ•° (æ¨ªå‘)</span>
                    <div class="flex items-center bg-[#767680]/10 rounded-md px-3 py-1.5">
                        <input type="number" id="cols" value="3" class="w-12 text-center text-[17px] font-medium focus:outline-none">
                        <span class="text-gray-500 text-xs ml-1">åˆ—</span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-400 mt-2 leading-tight">
                    * è®¾ç½®æ¨ªå‘æ’åˆ—å‡ å¼ å›¾ï¼Œè¡Œæ•°ä¼šè‡ªåŠ¨è®¡ç®—ã€‚<br>
                    * ä¾‹å¦‚ï¼š100å¼ å›¾è®¾ä¸º4åˆ—ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆ25è¡Œã€‚
                </div>
            </div>

            <input type="hidden" id="gap" value="0">
            
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition relative">
                <span class="text-[17px]">ç”»å¸ƒæ¯”ä¾‹</span>
                <div class="flex items-center gap-2">
                    <select id="aspectRatio" onchange="toggleCustomRatio()" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none text-right appearance-none cursor-pointer dir-rtl">
                        <option value="0.5625">9:16 æ‰‹æœºå…¨å±</option>
                        <option value="0.75">3:4 æµ·æŠ¥</option>
                        <option value="1">1:1 æ­£æ–¹å½¢</option>
                        <option value="1.333">4:3 ç…§ç‰‡</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
            </div>
            <div id="customRatioBox" class="hidden p-4 bg-gray-50 flex items-center justify-end gap-3 border-t border-gray-100">
                <input type="number" id="customW" placeholder="å®½" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1000">
                <span class="text-gray-400">:</span>
                <input type="number" id="customH" placeholder="é«˜" class="bg-white border rounded px-2 py-1 text-center w-20 text-sm" value="1500">
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">åºå·æ ‡æ³¨</div>
        <div class="ios-card ios-divide">
            <div class="flex items-center justify-between p-4 bg-white">
                <span class="text-[17px]">æ˜¾ç¤ºåºå·</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="showNum" checked class="sr-only peer">
                    <div class="w-[51px] h-[31px] bg-[#E9E9EA] peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-[27px] after:w-[27px] after:shadow-sm after:transition-all peer-checked:bg-[#34C759]"></div>
                </label>
            </div>
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">èµ·å§‹æ•°å€¼</span>
                <input type="number" id="startNumber" value="1" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20 bg-gray-50 rounded px-2 py-1" placeholder="1">
            </div>
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">å­—å·å¤§å°</span>
                <input type="number" id="fontSize" value="150" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-20" placeholder="150">
            </div>
            <div class="flex items-center justify-between p-4 bg-white active:bg-gray-50 transition">
                <span class="text-[17px]">ä½ç½®</span>
                <select id="fontPos" class="text-[#007AFF] text-[17px] pr-6 bg-transparent focus:outline-none appearance-none dir-rtl">
                    <option value="bottom-center">åº•éƒ¨å±…ä¸­</option>
                    <option value="bottom-left">åº•éƒ¨å·¦ä¾§</option>
                    <option value="bottom-right">åº•éƒ¨å³ä¾§</option>
                    <option value="center">æ­£ä¸­é—´</option>
                    <option value="top-left">å·¦ä¸Šè§’</option>
                    <option value="top-right">å³ä¸Šè§’</option>
                </select>
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium mt-6">å¯¼å‡ºä¸åˆ†ç»„ç­–ç•¥</div>
        <div class="ios-card ios-divide mb-6">
            <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[17px] font-bold">åå°åˆ†ç»„å¤„ç†</span>
                    <div class="flex items-center gap-2">
                        <input type="number" id="imagesPerBatch" value="50" class="bg-gray-100 rounded px-2 py-1 text-center w-16 text-[15px] font-bold text-[#007AFF]" onchange="validateBatchInput()">
                        <span class="text-xs text-gray-400">å¼ /ç»„</span>
                    </div>
                </div>
                <div class="text-[11px] text-gray-400 leading-tight">
                    *å¯¼å‡ºçš„åˆ—æ•°=æ‚¨ä¸€å¼€å§‹åœ¨æœ€ä¸Šé¢å¡«å†™çš„â€œåˆ—æ•°ï¼ˆæ¨ªå‘ï¼‰â€ï¼Œé€‚ç”¨äº100å¼ ä»¥ä¸Šæ‹¼å›¾æˆ–è€…åæœŸåˆ†ç»„å¯¼å‡ºã€‚
                   ä¾‹: å¡«9å¼ /ç»„ï¼Œå¯æŒ‰ä½ æ‰€å¡«çš„åˆ—æ•°9å¼ /ç»„ä¸€å¼ å¼ å¯¼å‡ºã€‚å»ºè®®åˆç†å¡«å†™ï¼Œå¦åˆ™æ‹¼å›¾å¯èƒ½ä¼šç•™ç©ºç™½ã€‚
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <div class="text-[13px] font-medium text-gray-800 mb-3 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    è‡ªå®šä¹‰å¯¼å‡ºå¸ƒå±€ (å¯é€‰)
                </div>
                <div class="flex gap-4 mb-2">
                    <div class="flex-1">
                        <label class="text-[11px] text-gray-500 block mb-1">å¯¼å‡ºåˆ—æ•°</label>
                        <input type="number" id="exportCols" placeholder="åŒé¢„è§ˆ" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm focus:border-[#007AFF] outline-none" oninput="calculateBatchSize()">
                    </div>
                    <div class="flex-1">
                        <label class="text-[11px] text-gray-500 block mb-1">å¯¼å‡ºè¡Œæ•°/ç»„</label>
                        <input type="number" id="exportRows" placeholder="è‡ªåŠ¨" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-center text-sm focus:border-[#007AFF] outline-none" oninput="calculateBatchSize()">
                    </div>
                </div>
                
                <div class="text-[11px] text-gray-400 bg-white/50 p-2 rounded border border-gray-100 leading-relaxed" id="layoutHint">
                    <span class="block mb-0.5">* è®¾ç½®åå°†æŒ‰ <b>"åˆ— Ã— è¡Œ"</b> é”å®šæ¯ç»„å¼ æ•°ã€‚</span>
                    <span>* ä¾‹å¦‚ï¼šè®¾ç½® 3åˆ— Ã— 5è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ¯ç»„è®¾ä¸º 15å¼ ã€‚</span>
                </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-white border-t border-gray-100">
                <span class="text-[17px]">å¯¼å‡ºç”»è´¨</span>
                <select id="exportQuality" class="text-[#007AFF] text-[15px] bg-transparent focus:outline-none text-right dir-rtl">
                    <option value="0.95">é«˜æ¸… (JPEG 95%)</option>
                    <option value="0.80">æ ‡å‡†å‹ç¼© (JPEG 80%)</option>
                    <option value="1.0">åŸå›¾æ— æŸ (PNG)</option>
                </select>
            </div>
        </div><div class="mb-2 pl-4 text-[13px] text-gray-500 uppercase font-medium">æ‰“ç  / è´´çº¸ (æ‹¼å›¾ååº”ç”¨)</div>
        <div class="ios-card ios-divide">
            <div class="p-4 bg-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex flex-col">
                        <span class="text-[17px] font-bold">ç›®æ ‡åºå·</span>
                        <span class="text-[10px] text-gray-400">è¾“å…¥æ•°å­— (å¦‚: 5, 12, 1-3)</span>
                    </div>
                    <input type="text" id="maskIndices" placeholder="å¦‚: 5, 12" class="text-right text-[#007AFF] text-[17px] focus:outline-none w-40 placeholder-gray-300 bg-gray-50 rounded px-2 py-1">
                </div>

                <div class="flex p-1 bg-gray-100 rounded-lg mb-4">
                    <button onclick="switchMaskTab('line')" id="tab-line" class="flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all">ç”»çº¿æ‰“ç </button>
                    <button onclick="switchMaskTab('image')" id="tab-image" class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all">å›¾ç‰‡/è´´çº¸</button>
                </div>

                <div id="mask-panel-line" class="animate-fade-in">
                    <div class="flex justify-between items-center pb-3 border-b border-gray-100 mb-3">
                        <span class="text-sm text-gray-500">å½¢çŠ¶æ ·å¼</span>
                        <div class="flex items-center gap-4 text-sm">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="lineStyle" value="cross" checked class="accent-[#FF3B30]"> 
                                <span>âŒ äº¤å‰</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="lineStyle" value="slash" class="accent-[#FF3B30]"> 
                                <span>â•± æ–œçº¿</span>
                            </label>
                        </div>
                    </div>

                    <div class="flex justify-between items-center py-2">
                         <span class="text-sm text-gray-500 w-20">é¢œè‰²/ç²—ç»†</span>
                         <div class="flex items-center flex-1 gap-3">
                             <input type="color" id="maskColor" value="#FF3B30" class="w-8 h-8 rounded-full border border-gray-200 shrink-0">
                             <div class="flex-1 h-8 flex items-center">
                                 <input type="range" id="maskWidth" min="1" max="20" value="10" class="w-full">
                             </div>
                         </div>
                    </div>
                </div>

                <div id="mask-panel-image" class="hidden animate-fade-in">
                    <button onclick="document.getElementById('stickerInput').click()" class="w-full py-2 border border-dashed border-gray-300 rounded-lg text-gray-500 text-sm mb-3 active:bg-gray-50">
                        + ä¸Šä¼ é®æŒ¡å›¾ (Logo/è´´çº¸)
                    </button>
                    
                    <div class="flex gap-4 mb-1">
                        <div class="w-24 h-24 checkered-bg rounded-lg overflow-hidden border border-gray-200 shrink-0 relative cursor-pointer active:scale-95 transition shadow-sm" onclick="enlargeStickerPreview()">
                            <canvas id="stickerPreviewCanvas" class="w-full h-full object-contain"></canvas>
                            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[9px] text-center py-0.5">ç‚¹å‡»æ”¾å¤§</div>
                        </div>
                        
                        <div class="flex-1 flex flex-col justify-center space-y-4">
                            <div class="flex items-center text-xs text-gray-500">
                                <span class="w-8 text-right mr-3">å¤§å°</span> 
                                <input type="range" id="stickerSize" min="10" max="200" value="50" class="flex-1">
                            </div>
                            <div class="flex items-center text-xs text-gray-500">
                                <span class="w-8 text-right mr-3">å·¦å³</span> 
                                <input type="range" id="stickerX" min="0" max="100" value="50" class="flex-1">
                            </div>
                            <div class="flex items-center text-xs text-gray-500">
                                <span class="w-8 text-right mr-3">ä¸Šä¸‹</span> 
                                <input type="range" id="stickerY" min="0" max="100" value="50" class="flex-1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 pt-0 grid grid-cols-2 gap-3 bg-white pb-4 rounded-b-xl">
                <button onclick="generateMasked('apply')" class="py-3 rounded-xl bg-[#007AFF]/10 active:bg-[#007AFF]/20 text-[#007AFF] font-bold text-[15px] transition-all flex items-center justify-center gap-1">
                    âœ¨ ç”Ÿæˆ/æ›´æ–°
                </button>
                <button onclick="generateMasked('repack')" class="py-3 rounded-xl bg-[#FF3B30]/10 active:bg-[#FF3B30]/20 text-[#FF3B30] font-bold text-[15px] transition-all flex items-center justify-center gap-1">
                    ğŸ”„ å‰”é™¤å¹¶é‡æ’
                </button>
            </div>
                <div id="resultArea" class="hidden pb-10">
            <div class="text-center text-gray-400 text-xs mb-3 font-medium">é¢„è§ˆç»“æœ (æ— ç¼æ‹¼æ¥)</div>
            
            <div class="ios-card bg-white p-0 shadow-lg overflow-hidden border border-gray-100">
                <div id="seamlessContainer" class="w-full flex flex-col bg-white"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="downloadZip()" class="col-span-2 bg-[#34C759] text-white text-[16px] font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    <span>æ‰“åŒ…ä¸‹è½½æ‰€æœ‰åˆ†ç»„ (ZIP)</span>
                    <span class="text-xs bg-white/20 px-1.5 py-0.5 rounded ml-1 font-normal">æ¨è</span>
                </button>

                <button onclick="combineAndDownload()" class="bg-white text-black border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">
                    åˆå¹¶ä¸ºä¸€å¼ é•¿å›¾
                </button>
                <button onclick="downloadAllParts()" class="bg-white text-[#007AFF] border border-gray-200 text-[14px] font-medium py-3 rounded-xl active:scale-95 transition">
                    é€å¼ ä¸‹è½½ (æ˜“é—æ¼)
                </button>
            </div>
        </div>

        <div class="py-10 pb-20 text-center">
            <div class="flex items-center justify-center gap-2 mb-3 opacity-30">
                <div class="h-px w-6 bg-black"></div>
                <div class="text-[10px] uppercase tracking-widest text-black font-semibold">About</div>
                <div class="h-px w-6 bg-black"></div>
            </div>
            <div class="space-y-1">
                <p class="text-xs text-gray-500 font-medium">æ‹¼å›¾Ultimate (Pro)</p>
                <p class="text-[10px] text-gray-400">Designed & Developed by <span class="text-gray-600 font-semibold">ikko</span></p>
                <p class="text-[10px] text-gray-300 pt-2 flex items-center justify-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    â‚Ë„Â·Íˆà¼Â·ÍˆË„â‚â— Ì‘Ì‘ Â·
                </p>
            </div>
        </div>

    </main>

    <div class="fixed bottom-8 left-0 right-0 px-4 z-40 pointer-events-none">
        <button onclick="generate()" class="pointer-events-auto w-full max-w-2xl mx-auto bg-black/90 backdrop-blur text-white font-semibold text-[17px] py-3.5 rounded-full shadow-2xl active:scale-[0.98] transition flex items-center justify-center gap-2">
            <span>âœ¨ å¼€å§‹ç”Ÿæˆæ‹¼å›¾</span>
        </button>
    </div>
    
    <canvas id="canvas" class="hidden"></canvas>
<div id="previewModal" class="modal-overlay" onclick="this.style.display='none'">
        <div class="bg-white p-2 rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center" style="max-width:90%; max-height:80%;" onclick="event.stopPropagation()">
            <canvas id="enlargedPreviewCanvas" class="object-contain" style="max-width:100%; max-height:70vh;"></canvas>
            <button onclick="document.getElementById('previewModal').style.display='none'" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center">Ã—</button>
        </div>
    </div>
    
    <div id="imageActionOverlay" class="modal-overlay" onclick="closeImageActions()"></div>
    <div id="imageActionSheet" class="action-sheet">
        <div class="text-center text-gray-400 text-sm mb-4 font-medium">å›¾ç‰‡æ“ä½œ</div>
        <div class="space-y-3">
            <button onclick="triggerReplace()" class="w-full bg-white text-[#007AFF] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">æ›¿æ¢å›¾ç‰‡</button>
            <button onclick="triggerDelete()" class="w-full bg-white text-[#FF3B30] font-bold text-[17px] py-3.5 rounded-xl shadow-sm active:bg-gray-50">åˆ é™¤å›¾ç‰‡</button>
        </div>
        <button onclick="closeImageActions()" class="w-full bg-white text-black font-semibold text-[17px] py-3.5 rounded-xl shadow-sm mt-4 active:bg-gray-50">å–æ¶ˆ</button>
    </div>

<script>
    let imagesData = [];
    let generatedBlobs = [];
    let stickerImg = null;
    let currentMaskMode = 'line';
    let targetImageIndex = -1; 
    let isCancelled = false; // å–æ¶ˆæ ‡è®°
    
    const MAX_CANVAS_DIMENSION = 8192; // iOSå®‰å…¨é™åˆ¶

    function switchMaskTab(mode) {
        currentMaskMode = mode;
        const lineTab = document.getElementById('tab-line');
        const imgTab = document.getElementById('tab-image');
        lineTab.className = mode==='line' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        imgTab.className = mode==='image' ? 'flex-1 py-1.5 text-xs font-medium rounded-md bg-white shadow text-black transition-all' : 'flex-1 py-1.5 text-xs font-medium rounded-md text-gray-500 transition-all';
        document.getElementById('mask-panel-line').style.display = mode==='line' ? 'block' : 'none';
        document.getElementById('mask-panel-image').style.display = mode==='image' ? 'block' : 'none';
        if(mode === 'image') updateStickerPreview();
    }

    function showLoading(show, text='å¤„ç†ä¸­...') {
        const el = document.getElementById('progressModal');
        if (show) { 
            isCancelled = false; 
            el.classList.remove('hidden'); 
            document.getElementById('progressText').innerText = text; 
        } else { 
            el.classList.add('hidden'); 
        }
    }
    
    function cancelProcess() {
        if(confirm('ç¡®å®šè¦åœæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
            isCancelled = true;
            showLoading(false);
        }
    }

    function toggleCustomRatio() { document.getElementById('customRatioBox').style.display = (document.getElementById('aspectRatio').value === 'custom') ? 'flex' : 'none'; }
    function validateBatchInput() { 
        let val = parseInt(document.getElementById('imagesPerBatch').value);
        if(val < 1) document.getElementById('imagesPerBatch').value = 1;
    }// --- å…³é”®ä¿®å¤ï¼šç§»é™¤ setTimeout å’Œ showLoadingï¼Œæ¢å¤ä¸ºæœ€åŸå§‹çš„åŒæ­¥å¯¼å…¥ ---
    function handleFiles(files) {
        if (!files.length) return;
        
        // ç›´æ¥å¤„ç†ï¼Œä¸ä½¿ç”¨ setTimeoutï¼Œé¿å…å¼¹çª—å¡æ­»
        const grid = document.getElementById('imageGrid');
        const fragment = document.createDocumentFragment();
        const startIndex = imagesData.length;
        
        Array.from(files).forEach((file, i) => {
            const url = URL.createObjectURL(file);
            imagesData.push(url);
            const div = document.createElement('div');
            div.className = 'relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-100 thumbnail-item active:opacity-80 transition cursor-pointer';
            div.innerHTML = `<img src="${url}" class="w-full h-full object-cover pointer-events-none">`;
            div.onclick = () => openImageActions(startIndex + i);
            fragment.appendChild(div);
        });
        
        grid.appendChild(fragment);
        refreshUI();
        document.getElementById('fileInput').value = '';
    }

    function openImageActions(index) { targetImageIndex = index; document.getElementById('imageActionOverlay').style.display = 'block'; setTimeout(() => document.getElementById('imageActionSheet').classList.add('show'), 10); }
    function closeImageActions() { document.getElementById('imageActionSheet').classList.remove('show'); setTimeout(() => document.getElementById('imageActionOverlay').style.display = 'none', 300); }
    function triggerReplace() { document.getElementById('replaceInput').click(); closeImageActions(); }
    function handleReplaceAction(files) {
        if(!files.length || targetImageIndex === -1) return;
        const url = URL.createObjectURL(files[0]);
        imagesData[targetImageIndex] = url;
        const item = document.querySelectorAll('.thumbnail-item img')[targetImageIndex];
        if(item) item.src = url;
        document.getElementById('replaceInput').value = '';
    }
    function triggerDelete() {
        if(confirm('ç¡®å®šåˆ é™¤?')) {
            imagesData.splice(targetImageIndex, 1);
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '<div id="emptyState" class="col-span-full py-8 text-center" style="display:none"><span class="text-gray-400">å¯¼å…¥å›¾ç‰‡</span></div>';
            const fragment = document.createDocumentFragment();
            imagesData.forEach((url, i) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-100 thumbnail-item active:opacity-80 transition cursor-pointer';
                div.innerHTML = `<img src="${url}" class="w-full h-full object-cover pointer-events-none">`;
                div.onclick = () => openImageActions(i);
                fragment.appendChild(div);
            });
            grid.appendChild(fragment);
            refreshUI();
        }
        closeImageActions();
    }
    function refreshUI() {
        document.getElementById('countBadge').innerText = imagesData.length;
        document.getElementById('emptyState').style.display = imagesData.length ? 'none' : 'flex';
        document.getElementById('clearBtn').style.display = imagesData.length ? 'block' : 'none';
        updateStickerPreview();
    }
    function clearAll() { if(confirm('ç¡®å®šæ¸…ç©º?')) { imagesData=[]; refreshUI(); document.getElementById('imageGrid').innerHTML = ''; document.getElementById('imageGrid').appendChild(document.getElementById('emptyState')); document.getElementById('emptyState').style.display = 'flex'; } }
    
    function handleStickerFile(files) {
        if(!files.length) return;
        const img = new Image();
        img.onload = () => { stickerImg = img; updateStickerPreview(); };
        img.src = URL.createObjectURL(files[0]);
    }
    
    function getCurrentRatio() {
        let ratio = parseFloat(document.getElementById('aspectRatio').value);
        if(isNaN(ratio) || document.getElementById('aspectRatio').value === 'custom') {
            const cw = parseInt(document.getElementById('customW').value) || 1000;
            const ch = parseInt(document.getElementById('customH').value) || 1500;
            ratio = cw / ch;
        }
        return ratio;
    }

    function updateStickerPreview() {
        const canvas = document.getElementById('stickerPreviewCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width = 300; const h = canvas.height = 300;
        ctx.clearRect(0,0,w,h);
        if (imagesData.length > 0) {
            const bgImg = new Image();
            bgImg.src = imagesData[0];
            if(bgImg.complete) drawPreviewContent(ctx, w, h, bgImg);
            else bgImg.onload = () => drawPreviewContent(ctx, w, h, bgImg);
        } else {
            ctx.fillStyle = '#f0f0f0'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = '#ccc'; ctx.textAlign = 'center'; ctx.fillText('æ— å›¾', w/2, h/2);
        }
    }
    
    function drawPreviewContent(ctx, w, h, bgImg) {
        const sRatio = bgImg.width / bgImg.height;
        const cRatio = w / h;
        if(sRatio > cRatio) ctx.drawImage(bgImg, (bgImg.width - bgImg.height*cRatio)/2, 0, bgImg.height*cRatio, bgImg.height, 0, 0, w, h);
        else ctx.drawImage(bgImg, 0, (bgImg.height - bgImg.width/cRatio)/2, bgImg.width, bgImg.width/cRatio, 0, 0, w, h);
        
        if (stickerImg) {
            const sizePct = document.getElementById('stickerSize').value / 100;
            const xPct = document.getElementById('stickerX').value / 100;
            const yPct = document.getElementById('stickerY').value / 100;
            const sw = w * sizePct;
            const sh = sw * (stickerImg.height / stickerImg.width);
            ctx.drawImage(stickerImg, (w * xPct) - sw/2, (h * yPct) - sh/2, sw, sh);
        }
    }

    function enlargeStickerPreview() {
        const modal = document.getElementById('previewModal');
        const largeCanvas = document.getElementById('enlargedPreviewCanvas');
        const ratio = getCurrentRatio();
        const baseW = 600;
        const baseH = baseW / ratio;
        largeCanvas.width = baseW;
        largeCanvas.height = baseH;
        const ctx = largeCanvas.getContext('2d');
        if (imagesData.length > 0) {
            const bgImg = new Image();
            bgImg.src = imagesData[0];
            bgImg.onload = () => {
                drawPreviewContent(ctx, baseW, baseH, bgImg);
                modal.style.display = 'flex';
            }
        } else {
            ctx.fillStyle = '#fff'; ctx.fillRect(0,0,baseW,baseH);
            modal.style.display = 'flex';
        }
    }        function calculateBatchSize() {
        const exCols = parseInt(document.getElementById('exportCols').value);
        const exRows = parseInt(document.getElementById('exportRows').value);
        const batchInput = document.getElementById('imagesPerBatch');
        const hint = document.getElementById('layoutHint');
        const totalImages = imagesData.length || 0; 
        
        if (exCols > 0 && exRows > 0) {
            const perBatch = exCols * exRows;
            batchInput.value = perBatch;
            const batches = totalImages > 0 ? Math.ceil(totalImages / perBatch) : 0;
            batchInput.disabled = true;
            batchInput.classList.add('opacity-50');
            
            let html = `<div class="text-[#007AFF] font-medium mb-0.5">âœ… å·²é”å®šå¸ƒå±€ï¼š${exCols}åˆ— Ã— ${exRows}è¡Œ = æ¯ç»„ ${perBatch} å¼ </div>`;
            if (totalImages > 0) {
                html += `<div class="text-gray-600">ğŸ“Š å¯¼å‡ºé¢„è§ˆï¼šå…± <b>${totalImages}</b> å¼ å›¾ï¼Œå°†è¢«åˆ‡åˆ†ä¸º <b>${batches}</b> ç»„æ–‡ä»¶ã€‚</div>`;
            } else {
                html += `<div class="text-gray-400">ğŸ“Š å¯¼å‡ºé¢„è§ˆï¼š(è¯·å…ˆå¯¼å…¥å›¾ç‰‡ä»¥è®¡ç®—åˆ†ç»„æ•°)</div>`;
            }
            hint.innerHTML = html;
            hint.classList.add('bg-[#007AFF]/5', 'border-[#007AFF]/20');
        } else {
            batchInput.disabled = false;
            batchInput.classList.remove('opacity-50');
            hint.innerHTML = `<span class="block mb-0.5">* è®¾ç½®åå°†æŒ‰ <b>"åˆ— Ã— è¡Œ"</b> é”å®šæ¯ç»„å¼ æ•°ã€‚</span><span>* ä¾‹å¦‚ï¼šè®¾ç½® 3åˆ— Ã— 5è¡Œï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†æ¯ç»„è®¾ä¸º 15å¼ ã€‚</span>`;
            hint.classList.remove('bg-[#007AFF]/5', 'border-[#007AFF]/20');
        }
    }

    async function generate() { await runGeneration('normal'); }
    async function generateMasked(type) { await runGeneration(type); }

    async function runGeneration(opType) {
        if (!imagesData.length) return alert('è¯·æ·»åŠ å›¾ç‰‡');
        const container = document.getElementById('seamlessContainer');
        container.innerHTML = ''; generatedBlobs = [];
        
        const startNum = parseInt(document.getElementById('startNumber').value) || 1;
        let targets = [...imagesData];

        // --- æ ¸å¿ƒä¿®å¤ï¼šæ”¯æŒ "1-5" è¿™ç§åŒºé—´å†™æ³• ---
        const rawInput = document.getElementById('maskIndices').value;
        let maskTargets = [];
        // 1. å…ˆæŒ‰é€—å·ã€ä¸­æ–‡é€—å·æˆ–ç©ºæ ¼åˆ†å‰²æˆç‰‡æ®µ
        const parts = rawInput.split(/[,ï¼Œ\s]+/);
        
        parts.forEach(part => {
            part = part.trim();
            if (!part) return;
            
            if (part.includes('-')) {
                // 2. å¦‚æœç‰‡æ®µé‡ŒåŒ…å«æ¨ªæ  (ä¾‹å¦‚ "1-5")
                const rangeParts = part.split('-');
                if (rangeParts.length === 2) {
                    const start = parseInt(rangeParts[0]);
                    const end = parseInt(rangeParts[1]);
                    // ç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œå¾ªç¯æ·»åŠ ä¸­é—´çš„æ‰€æœ‰æ•°å­—
                    if (!isNaN(start) && !isNaN(end)) {
                        const min = Math.min(start, end);
                        const max = Math.max(start, end);
                        for (let k = min; k <= max; k++) {
                            maskTargets.push(k);
                        }
                    }
                }
            } else {
                // 3. æ™®é€šå•æ•°å­— (ä¾‹å¦‚ "8")
                const num = parseInt(part);
                if (!isNaN(num)) {
                    maskTargets.push(num);
                }
            }
        });
        // -------------------------------------------
        
        if (opType === 'repack') targets = targets.filter((_, i) => !maskTargets.includes(startNum + i));

        const batchSize = parseInt(document.getElementById('imagesPerBatch').value) || 50;
        const customExportCols = parseInt(document.getElementById('exportCols').value);
        const previewCols = parseInt(document.getElementById('cols').value) || 3;
        const finalCols = (customExportCols > 0) ? customExportCols : previewCols;

        const totalBatches = Math.ceil(targets.length / batchSize);
        const quality = parseFloat(document.getElementById('exportQuality').value);
        const isPng = quality === 1.0;
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        showLoading(true, 'åˆå§‹åŒ–...');
        try {
            for (let b = 0; b < totalBatches; b++) {
                if (isCancelled) { console.log('ä»»åŠ¡å·²å–æ¶ˆ'); break; }

                showLoading(true, `ç”Ÿæˆç¬¬ ${b+1} / ${totalBatches} ç»„...`);
                const currentImgs = targets.slice(b*batchSize, Math.min((b+1)*batchSize, targets.length));
                
                const ratio = getCurrentRatio();
                const gap = parseInt(document.getElementById('gap').value) || 0;
                
                let cellW = 1500; 
                if (finalCols * cellW > MAX_CANVAS_DIMENSION) cellW = Math.floor((MAX_CANVAS_DIMENSION - (finalCols*gap)) / finalCols);
                let cellH = Math.floor(cellW / ratio);
                const rows = Math.ceil(currentImgs.length / finalCols);

                await drawAsync(ctx, currentImgs, rows, finalCols, cellW, cellH, gap, b*batchSize, startNum, maskTargets, opType === 'apply');
                
                if (isCancelled) break;

                await new Promise(res => canvas.toBlob(blob => {
                    if (isCancelled) { res(); return; }
                    generatedBlobs.push(blob);
                    const img = document.createElement('img'); 
                    img.src = URL.createObjectURL(blob);
                    img.className = "w-full block"; 
                    container.appendChild(img); 
                    res();
                }, isPng ? 'image/png' : 'image/jpeg', isPng ? undefined : quality));
                
                await new Promise(r => setTimeout(r, 50)); 
            }
            if (!isCancelled) {
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('resultArea').scrollIntoView({behavior:'smooth'});
            }
        } catch(e) { console.error(e); if(!isCancelled) alert('é”™è¯¯:'+e.message); }
        showLoading(false);
    }

    async function drawAsync(ctx, imgs, rows, cols, w, h, gap, globalOffset, startNum, maskIndices, applyMask) {
        if (isCancelled) return;

        const canvas = ctx.canvas;
        canvas.width = cols * w + (cols-1) * gap;
        canvas.height = rows * h + (rows-1) * gap;
        ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height);

        const showNum = document.getElementById('showNum').checked;
        const fontSize = parseInt(document.getElementById('fontSize').value);
        const fontPos = document.getElementById('fontPos').value;
        const lineStyle = document.querySelector('input[name="lineStyle"]:checked') ? document.querySelector('input[name="lineStyle"]:checked').value : 'cross';

        for (let i = 0; i < imgs.length; i++) {
            if (isCancelled) return;

            const r = Math.floor(i / cols);
            const c = i % cols;
            const x = c * (w + gap);
            const y = r * (h + gap);
            const currentNum = startNum + globalOffset + i;

            const img = new Image(); img.src = imgs[i];
            await new Promise(resolve => { if(img.complete)resolve(); else img.onload=resolve; img.onerror=resolve; });

            ctx.save(); ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
            const iRatio = img.width / img.height; const cRatio = w / h;
            if (iRatio > cRatio) ctx.drawImage(img, x - (h*iRatio - w)/2, y, h*iRatio, h);
            else ctx.drawImage(img, x, y - (w/iRatio - h)/2, w, w/iRatio);
            ctx.restore();

            if (showNum) {
                ctx.fillStyle = '#FFFFFF'; ctx.strokeStyle = '#000000'; ctx.lineWidth = fontSize / 15;
                ctx.font = `bold ${fontSize}px sans-serif`;
                let tx = x + w/2, ty = y + h - fontSize/2;
                if(fontPos === 'center') ty = y + h/2 + fontSize/3;
                else if(fontPos.includes('top')) ty = y + fontSize + 20;
                if(fontPos.includes('left')) { tx = x + 20; ctx.textAlign = 'left'; }
                else if(fontPos.includes('right')) { tx = x + w - 20; ctx.textAlign = 'right'; }
                else ctx.textAlign = 'center';
                ctx.strokeText(currentNum, tx, ty); ctx.fillText(currentNum, tx, ty);
            }

            if (applyMask && maskIndices.includes(currentNum)) {
                if (currentMaskMode === 'line') {
                    ctx.beginPath(); 
                    ctx.strokeStyle = document.getElementById('maskColor').value;
                    ctx.lineWidth = document.getElementById('maskWidth').value * (w/500) * 5; 
                    ctx.lineCap = 'round';
                    if (lineStyle === 'cross') {
                        ctx.moveTo(x+w*0.2, y+h*0.2); ctx.lineTo(x+w*0.8, y+h*0.8);
                        ctx.moveTo(x+w*0.8, y+h*0.2); ctx.lineTo(x+w*0.2, y+h*0.8);
                    } else {
                        ctx.moveTo(x+w*0.2, y+h*0.8); ctx.lineTo(x+w*0.8, y+h*0.2);
                    }
                    ctx.stroke();
                } else if (currentMaskMode === 'image' && stickerImg) {
                    const sizePct = document.getElementById('stickerSize').value / 100;
                    const xPct = document.getElementById('stickerX').value / 100;
                    const yPct = document.getElementById('stickerY').value / 100;
                    const sw = w * sizePct; const sh = sw * (stickerImg.height / stickerImg.width);
                    ctx.drawImage(stickerImg, x + (w * xPct) - sw/2, y + (h * yPct) - sh/2, sw, sh);
                }
            }
        }
    }

    function downloadZip() {
        if (!generatedBlobs.length) return alert('è¯·å…ˆç”Ÿæˆæ‹¼å›¾');
        showLoading(true, 'æ­£åœ¨æ‰“åŒ… ZIP...');
        const zip = new JSZip();
        const folder = zip.folder("æ‹¼å›¾åˆ†ç»„");
        generatedBlobs.forEach((blob, i) => {
            const ext = blob.type === 'image/png' ? 'png' : 'jpg';
            folder.file(`æ‹¼å›¾_Part_${i+1}.${ext}`, blob);
        });
        zip.generateAsync({type:"blob"}).then(function(content) {
            if(isCancelled) return;
            downloadBlob(content, `æ‹¼å›¾æ‰“åŒ…_${new Date().getTime()}.zip`);
            showLoading(false);
        }).catch(function(e) {
            if(!isCancelled) alert('æ‰“åŒ…å¤±è´¥: ' + e.message);
            showLoading(false);
        });
    }

    async function combineAndDownload() {
        if (!generatedBlobs.length) return;
        if (generatedBlobs.length === 1) { downloadBlob(generatedBlobs[0], 'æ‹¼å›¾_å®Œæ•´ç‰ˆ.jpg'); return; }
        
        showLoading(true, 'æ­£åœ¨åˆå¹¶é•¿å›¾...');
        try {
            const bitmaps = await Promise.all(generatedBlobs.map(b => createImageBitmap(b)));
            const totalH = bitmaps.reduce((sum, bmp) => sum + bmp.height, 0);
            const maxW = bitmaps[0].width;
            
            if(totalH > 30000) alert('è­¦å‘Šï¼šå›¾ç‰‡è¿‡é•¿ï¼Œåˆå¹¶å¯¼å‡ºå¯èƒ½ä¼šå¤±è´¥æˆ–ç©ºç™½ã€‚\nå»ºè®®ä½¿ç”¨ä¸Šæ–¹çš„"ZIPæ‰“åŒ…ä¸‹è½½"ã€‚');

            const canvas = document.createElement('canvas');
            canvas.width = maxW;
            canvas.height = totalH;
            const ctx = canvas.getContext('2d');
            
            let y = 0;
            for(let bmp of bitmaps) {
                if (isCancelled) break;
                ctx.drawImage(bmp, 0, y);
                y += bmp.height;
            }
            
            if(!isCancelled) {
                canvas.toBlob(blob => {
                    if (isCancelled) return;
                    downloadBlob(blob, `æ‹¼å›¾_åˆå¹¶ç‰ˆ_${new Date().getTime()}.jpg`);
                    showLoading(false);
                }, 'image/jpeg', 0.9);
            }
            
        } catch(e) {
            if(!isCancelled) alert('åˆå¹¶å¤±è´¥ (å†…å­˜ä¸è¶³æˆ–å›¾ç‰‡è¿‡å¤§)ï¼Œè¯·ä½¿ç”¨"æ‰“åŒ…ä¸‹è½½"åŠŸèƒ½ã€‚');
            showLoading(false);
        }
    }
    
    function downloadAllParts() {
        if(!confirm('æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡è¾ƒå¤šï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ‹¦æˆªéƒ¨åˆ†ä¸‹è½½ã€‚\nå»ºè®®ä½¿ç”¨ç»¿è‰²çš„ "ZIP æ‰“åŒ…" åŠŸèƒ½ã€‚\n\næ˜¯å¦ç»§ç»­é€å¼ ä¸‹è½½ï¼Ÿ')) return;
        generatedBlobs.forEach((blob, i) => {
            setTimeout(() => {
                const ext = blob.type === 'image/png' ? 'png' : 'jpg';
                downloadBlob(blob, `æ‹¼å›¾_Part_${i+1}.${ext}`);
            }, i * 300);
        });
    }

    function downloadBlob(blob, name) {
        const link = document.createElement('a');
        link.download = name;
        link.href = URL.createObjectURL(blob);
        link.click();
    }
</script>
</body>
</html>
